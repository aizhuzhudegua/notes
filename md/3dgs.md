# Splatting算法

![image-20240715202551950](images/image-20240715202551950.png)

# 简化的参考代码

https://github.com/SY-007-Research/3dgs_render_python

# 一、捏雪球

## 高斯椭球

均值就是球核

![image-20240715202722310](images/image-20240715202722310.png)

### 为什么高斯是椭球

![image-20240715203035649](images/image-20240715203035649.png)

椭球是一个球面

![image-20240715203757446](images/image-20240715203757446.png)

![image-20240715203812609](images/image-20240715203812609.png)

![image-20240715203927302](images/image-20240715203927302.png)

这部分是一个[0 , n ]的值，因此这里是一个椭球：

![image-20240715205310872](images/image-20240715205310872.png)



### 协方差矩阵

![image-20240715203216935](images/image-20240715203216935.png)

## 各向同性和各向异性

![image-20240715204955458](images/image-20240715204955458.png)

## 协方差矩阵如何控制椭球形状

![image-20240715205625254](images/image-20240715205625254.png)

![image-20240715210152527](images/image-20240715210152527.png)

### 怎么求RS：特征值分解

$$
\Sigma=Q\land Q^T \\
\Sigma=Q\land^\frac{1}{2} \land^\frac{1}{2} Q^T
$$

### 没有使用四元数，根据RS求协方差矩阵

mod默认是1，应该是对缩放做一个系数

![image-20240715213113731](images/image-20240715213113731.png)

# 二、抛雪球

就是光栅化，nerf使用的是逆光栅化，应该和ray tracing是差不多的

![image-20240715215157256](images/image-20240715215157256.png)

## 观测变换

世界坐标系 => 相机坐标系，即MVP中的V

![image-20240715215436523](images/image-20240715215436523.png)

## 投影变换

![image-20240715215607272](images/image-20240715215607272.png)

![image-20240715215753760](images/image-20240715215753760.png)

![image-20240715215910541](images/image-20240715215910541.png)

## 视口变换

![image-20240715220626608](images/image-20240715220626608.png)

## 光栅化

![image-20240715220802120](images/image-20240715220802120.png)

![image-20240715221114942](images/image-20240715221114942.png)

## 高斯球的观测变换

![image-20240715221315106](images/image-20240715221315106.png)

## 高斯球的投影变换

![image-20240715221536447](images/image-20240715221536447.png)

- 由于透视投影是非线性的，可能会引起协方差矩阵的形变，所以引入雅可比矩阵（极小的区域是线性的）
- EWA splatting这篇文章有说明，因为投影变换不能保证3d高斯到像素平面还是高斯的，但是线性化了之后可以保证3d高斯投影后就是一个2d高斯

## 雅可比矩阵

![image-20240715221735617](images/image-20240715221735617.png)

![image-20240715222225799](images/image-20240715222225799.png)

## 3dgs的投影变换

这里的雅可比矩阵是根据**投影转正交矩阵**得到的

![image-20240716133918234](images/image-20240716133918234.png)

![image-20240716135335454](images/image-20240716135335454.png)

![image-20240716135747300](images/image-20240716135747300.png)

## 投影变换后

![image-20240716134430392](images/image-20240716134430392.png)

## 3dgs的视口变换

![image-20240716140633357](images/image-20240716140633357.png)

## 3dgs中心变换

- projmatrix已经做了观测变换
- p_proj做了归一化，这个点位于[-1,1]^3立方体（NDC空间）
- point_image做了视口变换

![image-20240716141016801](images/image-20240716141016801.png)

- 这里第一行与x相关使用focalx，第二行与y相关使用focaly，由于投影之后不考虑z方向，所以最后一行为0
- viewmatrix[:3,:3]取了一个3*3的矩阵，【旋转 缩放】矩阵
- 在球核做雅可比，用它的局部线性做为仿射变换
- 高斯分布进行仿射变换时，需要左右同乘【旋转 缩放】矩阵；在透视投影到正交投影的变换过程中， 雅可比矩阵扮演了这个【旋转 缩放】矩阵的角色

![image-20240716141211052](images/image-20240716141211052.png)

# 三、雪球颜色

## 球谐函数

- 注意他和球无关，他表达的是各个方向上是什么颜色（颜色空间）
- 球谐函数用到3阶（0~3）

![image-20240718102332322](images/image-20240718102332322.png)

- 一共是16个系数c,c是三维的，所以sh就是一个16*3的矩阵


![image-20240718105235952](images/image-20240718105235952.png)

- sh是16x3的矩阵，每一行都是1x3的颜色值，对应公式中的:
  $$
  C^0_0...C^3_3
  $$

- SH_C0...SH_C3对应公式中的y
- 在这里相机的位置就是球心，连接高斯球核得到一个方向，r被归一化为1

# 疑问：这里只表达了高斯椭球核的颜色吗？我觉得是

![image-20240718110634802](images/image-20240718110634802.png)

![image-20240718111452129](images/image-20240718111452129.png)

![image-20240718111648893](images/image-20240718111648893.png)

## 合成图片

### alpha混合

将每一个高斯的足迹图混合，3dgs用的是逐像素的求颜色，就要用到nerf的体渲染公式

![image-20240718111955028](images/image-20240718111955028.png)

- C是足迹图中记录的
- 概率密度已知

# 疑问：概率密度如何求得？

- 求T

![image-20240718112253604](images/image-20240718112253604.png)

## 体渲染

![image-20240718112602172](images/image-20240718112602172.png)

- T是在s处没有被阻挡的概率，sigma是在s处被阻挡的概率密度函数

![image-20240718113124809](images/image-20240718113124809.png)

- sigma和C都是已知的

![image-20240719154309003](images/image-20240719154309003.png)

![image-20240719154525589](images/image-20240719154525589.png)

![image-20240719154755143](images/image-20240719154755143.png)

## 3dgs快在哪

![image-20240719160239624](images/image-20240719160239624.png)

## 渲染代码

![image-20240719160427980](images/image-20240719160427980.png)

# 四、参数评估

![image-20240719162027491](images/image-20240719162027491.png)

- knn为的是铺满整个画面

![image-20240719162450566](images/image-20240719162450566.png)

![image-20240719162648894](images/image-20240719162648894.png)